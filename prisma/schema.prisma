generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-1.0.x", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model AdminLog {
  id         String   @id
  adminId    String
  action     String
  targetType String
  targetId   String?
  productId  String?
  details    String?
  createdAt  DateTime @default(now())
  User       User     @relation(fields: [adminId], references: [id])
  Product    Product? @relation(fields: [productId], references: [id])

  @@index([action])
  @@index([adminId])
  @@index([createdAt])
  @@index([targetType])
}

model Category {
  id             String     @id
  name           String
  slug           String     @unique
  parentId       String?
  createdAt      DateTime   @default(now())
  Category       Category?  @relation("CategoryToCategory", fields: [parentId], references: [id])
  other_Category Category[] @relation("CategoryToCategory")
  Product        Product[]
}

model EmailTemplate {
  id          String   @id
  name        String   @unique
  subject     String
  htmlContent String
  variables   String?
  enabled     Boolean  @default(true)
  updatedAt   DateTime
  createdAt   DateTime @default(now())
}

model Order {
  id                  String      @id
  userId              String
  status              OrderStatus @default(PENDING)
  total               Float
  paymentMethod       String
  deliveryType        String
  createdAt           DateTime    @default(now())
  estimatedDelivery   DateTime?
  notes               String?
  shippingAddress     String?
  shippingCity        String?
  shippingName        String?
  shippingPhone       String?
  storeAddress        String?
  storeCity           String?
  storeId             String?
  storeName           String?
  trackingNumber      String?
  amountReceived      Float?
  deliveryPersonName  String?
  deliveryPersonPhone String?
  isPaid              Boolean     @default(false)
  paidAt              DateTime?
  cancellationReason  String?
  Store               Store?      @relation(fields: [storeId], references: [id])
  User                User        @relation(fields: [userId], references: [id])
  OrderItem           OrderItem[]
  
  // Suivi livraison manuel
  trackingUrl         String?
  deliveryStatus      DeliveryStatus @default(PENDING)
  shippingWilaya      String?
  
  // COD
  codAmount           Float?
  codReceived         Boolean     @default(false)
  codReceivedAt       DateTime?
  codReceivedAmount   Float?
  paymentReceipt      String?
  
  // Notes vendeur
  sellerNotes         String?
  lastUpdatedBy       String?
  lastUpdatedAt       DateTime?
  
  // Relation avec système de livraison
  delivery            Delivery?

  @@index([createdAt])
  @@index([isPaid])
  @@index([status])
  @@index([storeId])
  @@index([userId])
  @@index([deliveryStatus])
}

model OrderItem {
  id        String  @id
  orderId   String
  variantId String
  quantity  Int
  price     Float
  Order     Order   @relation(fields: [orderId], references: [id])
  Variant   Variant @relation(fields: [variantId], references: [id])

  @@index([orderId])
  @@index([variantId])
}

model PasswordResetToken {
  id        String   @id
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([expiresAt])
  @@index([token])
  @@index([userId])
}

model Product {
  id              String     @id
  title           String
  description     String
  price           Int
  images          String
  categoryId      String?
  storeId         String
  status          String     @default("PENDING")
  rejectionReason String?
  createdAt       DateTime   @default(now())
  dimensions      String?
  discountPrice   Float?
  fit             String?
  material        String?
  promotionLabel  String?
  technicalSpecs  String?
  warranty        String?
  AdminLog        AdminLog[]
  Category        Category?  @relation(fields: [categoryId], references: [id])
  Store           Store      @relation(fields: [storeId], references: [id])
  Review          Review[]
  Variant         Variant[]
  Wishlist        Wishlist[]

  @@index([categoryId])
  @@index([createdAt])
  @@index([status])
  @@index([storeId])
}

model Review {
  id        String   @id
  rating    Int
  comment   String?
  images    String?
  userId    String
  productId String
  createdAt DateTime @default(now())
  Product   Product  @relation(fields: [productId], references: [id])
  User      User     @relation(fields: [userId], references: [id])

  @@index([productId])
  @@index([userId])
}

model Store {
  id                      String          @id
  name                    String
  description             String?
  ownerId                 String          @unique
  latitude                Float?
  longitude               Float?
  address                 String?
  city                    String?
  phone                   String?
  hours                   String?
  clickCollect            Boolean         @default(true)
  createdAt               DateTime        @default(now())
  verified                Boolean         @default(false)
  verifiedAt              DateTime?
  verifiedBy              String?
  
  // Prestataire par défaut
  defaultDeliveryAgentId  String?
  defaultDeliveryAgent    DeliveryAgent?  @relation(fields: [defaultDeliveryAgentId], references: [id])
  
  Order                   Order[]
  Product                 Product[]
  User                    User            @relation(fields: [ownerId], references: [id])
}

model SystemSettings {
  id          String   @id
  key         String   @unique
  value       String
  description String?
  category    String   @default("GENERAL")
  updatedAt   DateTime
  createdAt   DateTime @default(now())

  @@index([category])
}

model User {
  id                 String               @id
  email              String               @unique
  password           String
  name               String?
  role               String               @default("BUYER") // Deprecated, use roles
  roles              Role[]               @default([BUYER])
  address            String?
  city               String?
  wilaya             String?
  phone              String?
  createdAt          DateTime             @default(now())
  AdminLog           AdminLog[]
  Order              Order[]
  PasswordResetToken PasswordResetToken[]
  Review             Review[]
  Store              Store?
  Wishlist           Wishlist[]
  DeliveryAgent      DeliveryAgent?
}

model Variant {
  id        String      @id
  productId String
  size      String
  color     String
  stock     Int
  OrderItem OrderItem[]
  Product   Product     @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
}

model Wishlist {
  id        String   @id
  userId    String
  productId String
  createdAt DateTime @default(now())
  Product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([productId])
  @@index([userId])
}

enum OrderStatus {
  PENDING
  CONFIRMED
  READY
  SHIPPED
  DELIVERED
  CANCELLED
}

enum DeliveryStatus {
  PENDING
  ACCEPTED
  READY_TO_SHIP
  PICKED_UP
  IN_TRANSIT
  DELIVERED
  FAILED
  RETURNED
}

enum Role {
  BUYER
  SELLER
  DELIVERY_AGENT
  ADMIN
}

model DeliveryAgent {
  id              String     @id
  userId          String     @unique
  user            User       @relation(fields: [userId], references: [id])
  
  // Informations livreur
  provider        String     // "YALIDINE", "ECOLOG", "INDEPENDENT"
  vehicleType     String?    // "MOTO", "VOITURE", "CAMIONNETTE"
  licenseNumber   String?
  wilayasCovered  String[]   // ["Oran", "Alger", ...]
  
  // Statut
  isActive        Boolean    @default(true)
  isVerified      Boolean    @default(false)
  
  // Statistiques
  totalDeliveries Int        @default(0)
  successRate     Float      @default(0)
  
  // Relations
  deliveries      Delivery[]
  stores          Store[]    // Magasins qui utilisent ce prestataire par défaut
  
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  
  @@index([userId])
  @@index([isActive])
  @@index([provider])
}

model Delivery {
  id                String           @id
  orderId           String           @unique
  order             Order            @relation(fields: [orderId], references: [id])
  
  // Assignation livreur
  agentId           String?
  agent             DeliveryAgent?   @relation(fields: [agentId], references: [id])
  assignedAt        DateTime?
  
  // Statut et tracking
  status            DeliveryStatus   @default(PENDING)
  trackingNumber    String?
  trackingUrl       String?
  
  // COD (Cash on Delivery)
  codAmount         Float?
  codCollected      Boolean          @default(false)
  codCollectedAt    DateTime?
  codTransferred    Boolean          @default(false)
  codTransferredAt  DateTime?
  
  // Notes livreur
  agentNotes        String?
  
  // Timestamps
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  
  @@index([orderId])
  @@index([agentId])
  @@index([status])
}
