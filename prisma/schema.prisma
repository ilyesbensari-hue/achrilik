generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-1.0.x", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model AdminLog {
  id         String   @id
  adminId    String
  action     String
  targetType String
  targetId   String?
  productId  String?
  details    String?
  createdAt  DateTime @default(now())
  User       User     @relation(fields: [adminId], references: [id])
  Product    Product? @relation(fields: [productId], references: [id])

  @@index([action])
  @@index([adminId])
  @@index([createdAt])
  @@index([targetType])
}

model Banner {
  id          String   @id @default(cuid())
  title       String
  title_ar    String?  // Titre en arabe
  subtitle    String?
  subtitle_ar String?  // Sous-titre en arabe
  image       String
  videoUrl    String?  // NEW: Support vidéo/animation
  link        String?
  buttonText  String   @default("Voir l'offre")
  buttonText_ar String? // Texte bouton en arabe
  isActive    Boolean  @default(true)
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Category {
  id          String     @id @default(cuid())
  name        String     // Ex: "T-Shirts & Polos"
  slug        String     @unique // Ex: "tshirts-polos"
  description String?
  image       String?    // URL image catégorie
  icon        String?    // Emoji ou icône
  
  // Hiérarchie (3 niveaux: Vêtements > Homme > T-Shirts)
  parentId    String?
  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children    Category[] @relation("CategoryHierarchy")
  
  // Ordre d'affichage
  order       Int        @default(0)
  
  // SEO
  metaTitle       String?
  metaDescription String?
  keywords        String[] // Array de mots-clés
  
  // Statut
  isActive    Boolean    @default(true)
  isFeatured  Boolean    @default(false)
  
  // Relations
  products    Product[]
  
  // Timestamps
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  
  @@index([parentId])
  @@index([slug])
}

model EmailTemplate {
  id          String   @id
  name        String   @unique
  subject     String
  htmlContent String
  variables   String?
  enabled     Boolean  @default(true)
  updatedAt   DateTime
  createdAt   DateTime @default(now())
}

model Order {
  id                  String         @id
  userId              String
  total               Float
  paymentMethod       String
  deliveryType        String
  createdAt           DateTime       @default(now())
  estimatedDelivery   DateTime?
  notes               String?
  shippingAddress     String?
  shippingCity        String?
  shippingName        String?
  shippingPhone       String?
  storeAddress        String?
  storeCity           String?
  storeId             String?
  storeName           String?
  trackingNumber      String?
  amountReceived      Float?
  deliveryPersonName  String?
  deliveryPersonPhone String?
  isPaid              Boolean        @default(false)
  paidAt              DateTime?
  cancellationReason  String?
  status              OrderStatus    @default(PENDING)
  codAmount           Float?
  codReceived         Boolean        @default(false)
  codReceivedAmount   Float?
  codReceivedAt       DateTime?
  deliveryStatus      DeliveryStatus @default(PENDING)
  lastUpdatedAt       DateTime?
  lastUpdatedBy       String?
  paymentReceipt      String?
  sellerNotes         String?
  shippingWilaya      String?
  deliveryLatitude    Float?         // GPS coordinates for delivery
  deliveryLongitude   Float?         // GPS coordinates for delivery
  trackingUrl         String?
  statusHistory       Json?          // Historique transitions status [{from, to, at, by}]
  merchantNotes       String?        // Notes du commerçant
  deliveryNotes       String?        // Notes du livreur
  delivery            Delivery?
  Store               Store?         @relation(fields: [storeId], references: [id])
  User                User           @relation(fields: [userId], references: [id])
  OrderItem           OrderItem[]
  Review              Review[]       // NEW: Avis liés à cette commande

  @@index([createdAt])
  @@index([isPaid])
  @@index([status])
  @@index([storeId])
  @@index([userId])
  @@index([deliveryStatus])
}

model OrderItem {
  id        String  @id
  orderId   String
  variantId String
  quantity  Int
  price     Float
  Order     Order   @relation(fields: [orderId], references: [id])
  Variant   Variant @relation(fields: [variantId], references: [id])

  @@index([orderId])
  @@index([variantId])
}

model PasswordResetToken {
  id        String   @id
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([expiresAt])
  @@index([token])
  @@index([userId])
}

model Product {
  id              String     @id @default(cuid())
  title           String
  description     String
  price           Int
  images          String
  categoryId      String?
  storeId         String
  status          String     @default("PENDING")
  rejectionReason String?
  createdAt       DateTime   @default(now())
  
  // CARACTÉRISTIQUES DÉTAILLÉES
  // Matière & Composition
  material        String?    // Ex: "100% Coton Bio"
  composition     String?    // Détails composition
  
  // Coupe & Style
  cutType         String?    // Ex: "Slim Fit", "Regular Fit"
  fit             String?    // Ex: "Ajusté", "Ample"
  length          String?    // Ex: "Manches courtes", "Longueur genou"
  
  // Détails de Design
  neckline        String?    // Ex: "Col rond", "Col V", "Col chemise"
  pattern         String?    // Ex: "Uni", "Rayé", "Imprimé"
  closure         String?    // Ex: "Boutons", "Zip", "Élastique"
  pockets         String?    // Ex: "2 poches latérales"
  
  // Entretien
  careInstructions String?   // Ex: "Lavage machine 30°, Ne pas repasser"
  
  // Origine & Fabrication
  countryOfManufacture String? // Pays de fabrication
  brand           String?    // Ex: "Achrilik Original"
  supplierReference String?  // Référence fournisseur
  
  // STOCKAGE ET LOGISTIQUE - NEW
  storageZone     String?    // Zone de stockage du produit
  storageWilaya   String?    // Wilaya de stockage (58 wilayas)
  
  // Guide des Tailles
  sizeGuide       String?    // JSON ou texte
  availableSizes  String[]   // Ex: ["S", "M", "L", "XL"]
  
  // Dimensions & Poids (pour livraison)
  dimensions      String?    // Texte libre (legacy)
  weight          Float?     // En kg
  productLength   Float?     // En cm (renamed from 'length' to avoid conflict)
  width           Float?     // En cm
  height          Float?     // En cm
  
  // Promotion & Pricing
  discountPrice   Float?
  promotionLabel  String?
  
  // Specs & Warranty
  technicalSpecs  String?
  warranty        String?
  
  // BADGES & LABELS
  badges          String[]   // Ex: ["Nouveauté", "Éco-responsable", "Made in Algeria"]
  isNew           Boolean    @default(false)
  isTrending      Boolean    @default(false)
  isBestSeller    Boolean    @default(false)
  
  // SEO
  metaTitle       String?
  metaDescription String?
  keywords        String[]   @default([])
  
  // STATISTIQUES
  viewCount       Int        @default(0)
  favoriteCount   Int        @default(0)
  salesCount      Int        @default(0)
  
  // RELATIONS
  AdminLog        AdminLog[]
  Category        Category?  @relation(fields: [categoryId], references: [id])
  Store           Store      @relation(fields: [storeId], references: [id])
  Review          Review[]
  Variant         Variant[]
  Wishlist        Wishlist[]

  @@index([categoryId])
  @@index([createdAt])
  @@index([status])
  @@index([storeId])
}

model Review {
  id                 String    @id @default(cuid())
  
  // Relations
  productId          String
  userId             String
  orderId            String?   // NEW: Lien vers la commande pour vérifier l'achat
  
  // Contenu avis
  rating             Int       // 1-5
  title              String?   // Titre de l'avis
  comment            String?   // Commentaire
  
  // Photos client (array d'URLs)
  images             String?   // Legacy: single string
  photos             String[]  @default([]) // New: array of URLs
  
  // Vérification
  isVerifiedPurchase Boolean   @default(false)
  
  // Réponse vendeur
  sellerResponse     String?
  sellerResponseDate DateTime?
  
  // Utilité
  helpfulCount       Int       @default(0)
  
  // Timestamps
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  
  // Relations
  Product            Product   @relation(fields: [productId], references: [id])
  User               User      @relation(fields: [userId], references: [id])
  Order              Order?    @relation(fields: [orderId], references: [id])

  @@unique([userId, productId]) // Un seul avis par utilisateur/produit
  @@index([productId])
  @@index([userId])
  @@index([orderId])
}

model Store {
  id                     String         @id
  name                   String
  description            String?
  ownerId                String         @unique
  latitude               Float?
  longitude              Float?
  address                String?
  city                   String?
  storageCity            String?        @db.VarChar(100) // Ville où les produits sont stockés physiquement
  phone                  String?
  hours                  String?
  clickCollect           Boolean        @default(true)
  createdAt              DateTime       @default(now())
  verified               Boolean        @default(false)
  verifiedAt             DateTime?
  verifiedBy             String?
  defaultDeliveryAgentId String?
  
  // LIVRAISON GRATUITE - Par boutique/commande
  offersFreeDelivery     Boolean        @default(false) // Livraison gratuite si montant minimum atteint
  freeDeliveryThreshold  Int?           // Montant minimum pour livraison gratuite (en DA)
  
  Order                  Order[]
  Product                Product[]
  defaultDeliveryAgent   DeliveryAgent? @relation(fields: [defaultDeliveryAgentId], references: [id])
  User                   User           @relation(fields: [ownerId], references: [id])
}

model SystemSettings {
  id          String   @id
  key         String   @unique
  value       String
  description String?
  category    String   @default("GENERAL")
  updatedAt   DateTime
  createdAt   DateTime @default(now())

  @@index([category])
}

model User {
  id                 String               @id
  email              String               @unique
  password           String
  name               String?
  role               String               @default("BUYER")
  address            String?
  phone              String?
  createdAt          DateTime             @default(now())
  city               String?
  roles              Role[]               @default([BUYER])
  wilaya             String?
  latitude           Float?               // GPS coordinates
  longitude          Float?               // GPS coordinates
  AdminLog           AdminLog[]
  DeliveryAgent      DeliveryAgent?
  Order              Order[]
  PasswordResetToken PasswordResetToken[]
  Review             Review[]
  Store              Store?
  Wishlist           Wishlist[]
}

model Variant {
  id              String      @id @default(cuid())
  productId       String
  
  // SKU unique par variant
  sku             String?     @unique // Ex: "ACH-HOM-TSH-001-M-NOIR"
  
  // Attributs du variant
  size            String      // Ex: "M", "42", "L"
  color           String      // Ex: "Noir"
  colorHex        String?     // Ex: "#000000"
  colorImage      String?     // URL image de ce variant
  
  // Stock & Prix
  stock           Int
  priceAdjustment Float?      // Prix supplémentaire si variant plus cher
  
  // Statut
  isAvailable     Boolean     @default(true)
  
  // Timestamps
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  // Relations
  OrderItem       OrderItem[]
  Product         Product     @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([sku])
}

model Wishlist {
  id        String   @id
  userId    String
  productId String
  createdAt DateTime @default(now())
  Product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([productId])
  @@index([userId])
}

model DeliveryAgent {
  id              String     @id
  userId          String     @unique
  provider        String
  vehicleType     String?
  licenseNumber   String?
  wilayasCovered  String[]
  isActive        Boolean    @default(true)
  isVerified      Boolean    @default(false)
  totalDeliveries Int        @default(0)
  successRate     Float      @default(0)
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  deliveries      Delivery[]
  user            User       @relation(fields: [userId], references: [id])
  stores          Store[]

  @@index([userId])
  @@index([isActive])
  @@index([provider])
}

model Delivery {
  id               String         @id
  orderId          String         @unique
  agentId          String?
  assignedAt       DateTime?
  status           DeliveryStatus @default(PENDING)
  trackingNumber   String?
  trackingUrl      String?
  codAmount        Float?
  codCollected     Boolean        @default(false)
  codCollectedAt   DateTime?
  codTransferred   Boolean        @default(false)
  codTransferredAt DateTime?
  agentNotes       String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  agent            DeliveryAgent? @relation(fields: [agentId], references: [id])
  order            Order          @relation(fields: [orderId], references: [id])

  @@index([orderId])
  @@index([agentId])
  @@index([status])
}

enum OrderStatus {
  PENDING              // En attente (client vient de commander)
  PAYMENT_PENDING      // Paiement en attente
  CONFIRMED            // Confirmée par client
  AT_MERCHANT          // Chez le commerçant (préparation)
  READY_FOR_PICKUP     // Prête pour enlèvement livreur
  WITH_DELIVERY_AGENT  // Chez le livreur
  OUT_FOR_DELIVERY     // En cours de livraison
  DELIVERED            // Livrée
  RETURNED             // Retournée (échec livraison)
  CANCELLED            // Annulée
}

// Configuration des frais de livraison gérés par l'admin
model DeliveryFeeConfig {
  id                     String   @id @default(cuid())
  fromCity               String   @db.VarChar(100)  // Ville de stockage (ex: "Oran")
  toWilaya               String   @db.VarChar(100)  // Wilaya de destination (ex: "Oran", "Alger", "Autre")
  baseFee                Int      @default(500)     // Frais de base en DA
  isActive               Boolean  @default(true)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@unique([fromCity, toWilaya])
  @@index([fromCity])
  @@index([toWilaya])
}

enum DeliveryStatus {
  PENDING
  ACCEPTED
  READY_TO_SHIP
  PICKED_UP
  IN_TRANSIT
  DELIVERED
  FAILED
  RETURNED
}

enum Role {
  BUYER
  SELLER
  DELIVERY_AGENT
  ADMIN
}

// System configuration for feature flags and maintenance mode
model SystemConfig {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt
  updatedBy String?
  
  @@index([key])
}
