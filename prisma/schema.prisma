generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-1.0.x", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model AdminLog {
  id         String   @id
  adminId    String
  action     String
  targetType String
  targetId   String?
  productId  String?
  details    String?
  createdAt  DateTime @default(now())
  User       User     @relation(fields: [adminId], references: [id])
  Product    Product? @relation(fields: [productId], references: [id])

  @@index([action])
  @@index([adminId])
  @@index([createdAt])
  @@index([targetType])
}

model Banner {
  id            String   @id @default(cuid())
  title         String
  title_ar      String?
  subtitle      String?
  subtitle_ar   String?
  image         String
  videoUrl      String?
  link          String?
  buttonText    String   @default("Voir l'offre")
  buttonText_ar String?
  isActive      Boolean  @default(true)
  order         Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Category {
  id              String     @id @default(cuid())
  name            String
  slug            String     @unique
  description     String?
  image           String?
  icon            String?
  parentId        String?
  order           Int        @default(0)
  metaTitle       String?
  metaDescription String?
  keywords        String[]
  isActive        Boolean    @default(true)
  isFeatured      Boolean    @default(false)
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  parent          Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children        Category[] @relation("CategoryHierarchy")
  products        Product[]

  @@index([parentId])
  @@index([slug])
}

model EmailTemplate {
  id          String   @id
  name        String   @unique
  subject     String
  htmlContent String
  variables   String?
  enabled     Boolean  @default(true)
  updatedAt   DateTime
  createdAt   DateTime @default(now())
}

model Order {
  id                     String         @id
  userId                 String
  total                  Float
  paymentMethod          String
  deliveryType           String
  createdAt              DateTime       @default(now())
  estimatedDelivery      DateTime?
  notes                  String?
  shippingAddress        String?
  shippingCity           String?
  shippingName           String?
  shippingPhone          String?
  storeAddress           String?
  storeCity              String?
  storeId                String?
  storeName              String?
  trackingNumber         String?
  amountReceived         Float?
  deliveryPersonName     String?
  deliveryPersonPhone    String?
  isPaid                 Boolean        @default(false)
  paidAt                 DateTime?
  cancellationReason     String?
  status                 OrderStatus    @default(PENDING)
  codAmount              Float?
  codReceived            Boolean        @default(false)
  codReceivedAmount      Float?
  codReceivedAt          DateTime?
  deliveryStatus         DeliveryStatus @default(PENDING)
  lastUpdatedAt          DateTime?
  lastUpdatedBy          String?
  paymentReceipt         String?
  sellerNotes            String?
  shippingWilaya         String?
  deliveryLatitude       Float?
  deliveryLongitude      Float?
  trackingUrl            String?
  statusHistory          Json?
  merchantNotes          String?
  deliveryNotes          String?
  commissionPaid         Boolean        @default(false)
  commissionPaidAt       DateTime?
  commissionPaymentNote  String?
  platformCommission     Float?
  platformCommissionRate Float?
  actualDeliveryFee      Float?         @default(0)
  customerDeliveryFee    Float?         @default(0)
  freeDeliveryApplied    Boolean        @default(false)
  subtotal               Float?
  delivery               Delivery?
  Store                  Store?         @relation(fields: [storeId], references: [id])
  User                   User           @relation(fields: [userId], references: [id])
  OrderItem              OrderItem[]
  Review                 Review[]

  @@index([createdAt])
  @@index([isPaid])
  @@index([status])
  @@index([storeId])
  @@index([userId])
  @@index([deliveryStatus])
}

model OrderItem {
  id        String  @id
  orderId   String
  variantId String
  quantity  Int
  price     Float
  Order     Order   @relation(fields: [orderId], references: [id])
  Variant   Variant @relation(fields: [variantId], references: [id])

  @@index([orderId])
  @@index([variantId])
}

model PasswordResetToken {
  id        String   @id
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([expiresAt])
  @@index([token])
  @@index([userId])
}

model Product {
  id                   String     @id @default(cuid())
  title                String
  description          String
  price                Int
  images               String
  categoryId           String?
  storeId              String
  status               String     @default("PENDING")
  rejectionReason      String?
  createdAt            DateTime   @default(now())
  material             String?
  composition          String?
  cutType              String?
  fit                  String?
  length               String?
  neckline             String?
  pattern              String?
  closure              String?
  pockets              String?
  careInstructions     String?
  countryOfManufacture String?
  brand                String?
  supplierReference    String?
  sizeGuide            String?
  availableSizes       String[]
  dimensions           String?
  weight               Float?
  productLength        Float?
  width                Float?
  height               Float?
  discountPrice        Float?
  promotionLabel       String?
  technicalSpecs       String?
  warranty             String?
  badges               String[]
  isNew                Boolean    @default(false)
  isTrending           Boolean    @default(false)
  isBestSeller         Boolean    @default(false)
  metaTitle            String?
  metaDescription      String?
  keywords             String[]   @default([])
  viewCount            Int        @default(0)
  favoriteCount        Int        @default(0)
  salesCount           Int        @default(0)
  storageWilaya        String?
  storageZone          String?
  AdminLog             AdminLog[]
  Category             Category?  @relation(fields: [categoryId], references: [id])
  Store                Store      @relation(fields: [storeId], references: [id])
  Review               Review[]
  Variant              Variant[]
  Wishlist             Wishlist[]

  @@index([categoryId])
  @@index([createdAt])
  @@index([status])
  @@index([storeId])
}

model Review {
  id                 String    @id @default(cuid())
  productId          String
  userId             String
  orderId            String?
  rating             Int
  title              String?
  comment            String?
  images             String?
  photos             String[]  @default([])
  isVerifiedPurchase Boolean   @default(false)
  sellerResponse     String?
  sellerResponseDate DateTime?
  helpfulCount       Int       @default(0)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  Order              Order?    @relation(fields: [orderId], references: [id])
  Product            Product   @relation(fields: [productId], references: [id])
  User               User      @relation(fields: [userId], references: [id])

  @@unique([userId, productId])
  @@index([productId])
  @@index([userId])
  @@index([orderId])
}

model Store {
  id                     String         @id
  name                   String
  description            String?
  ownerId                String         @unique
  latitude               Float?
  longitude              Float?
  address                String?
  city                   String?
  storageCity            String?        @db.VarChar(100)
  phone                  String?
  hours                  String?
  clickCollect           Boolean        @default(true)
  createdAt              DateTime       @default(now())
  verified               Boolean        @default(false)
  verifiedAt             DateTime?
  verifiedBy             String?
  defaultDeliveryAgentId String?
  freeDeliveryThreshold  Int?
  offersFreeDelivery     Boolean        @default(false)
  Order                  Order[]
  Product                Product[]
  defaultDeliveryAgent   DeliveryAgent? @relation(fields: [defaultDeliveryAgentId], references: [id])
  User                   User           @relation(fields: [ownerId], references: [id])
}

model SystemSettings {
  id          String   @id
  key         String   @unique
  value       String
  description String?
  category    String   @default("GENERAL")
  updatedAt   DateTime
  createdAt   DateTime @default(now())

  @@index([category])
}

model PlatformSettings {
  id             String   @id @default(cuid())
  commissionRate Float    @default(0)
  updatedAt      DateTime @updatedAt
  updatedBy      String?
  previousRate   Float?

  @@index([updatedAt])
}

model User {
  id                 String               @id
  email              String               @unique
  password           String
  name               String?
  role               String               @default("BUYER")
  address            String?
  phone              String?
  createdAt          DateTime             @default(now())
  city               String?
  roles              Role[]               @default([BUYER])
  wilaya             String?
  latitude           Float?
  longitude          Float?
  AdminLog           AdminLog[]
  DeliveryAgent      DeliveryAgent?
  Order              Order[]
  PasswordResetToken PasswordResetToken[]
  Review             Review[]
  Store              Store?
  Wishlist           Wishlist[]
}

model Variant {
  id              String      @id @default(cuid())
  productId       String
  sku             String?     @unique
  size            String?
  color           String
  colorHex        String?
  colorImage      String?
  stock           Int
  priceAdjustment Float?
  isAvailable     Boolean     @default(true)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  height          Float?
  length          Float?
  width           Float?
  OrderItem       OrderItem[]
  Product         Product     @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([sku])
}

model Wishlist {
  id        String   @id
  userId    String
  productId String
  createdAt DateTime @default(now())
  Product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([productId])
  @@index([userId])
}

model DeliveryAgent {
  id              String     @id
  userId          String     @unique
  provider        String
  vehicleType     String?
  licenseNumber   String?
  wilayasCovered  String[]
  isActive        Boolean    @default(true)
  isVerified      Boolean    @default(false)
  totalDeliveries Int        @default(0)
  successRate     Float      @default(0)
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  deliveries      Delivery[]
  user            User       @relation(fields: [userId], references: [id])
  stores          Store[]

  @@index([userId])
  @@index([isActive])
  @@index([provider])
}

model Delivery {
  id               String         @id
  orderId          String         @unique
  agentId          String?
  assignedAt       DateTime?
  status           DeliveryStatus @default(PENDING)
  trackingNumber   String?
  trackingUrl      String?
  codAmount        Float?
  codCollected     Boolean        @default(false)
  codCollectedAt   DateTime?
  codTransferred   Boolean        @default(false)
  codTransferredAt DateTime?
  agentNotes       String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  agentPaid        Boolean        @default(false)
  agentPaidAt      DateTime?
  agentPaymentNote String?
  deliveryFee      Float?
  agent            DeliveryAgent? @relation(fields: [agentId], references: [id])
  order            Order          @relation(fields: [orderId], references: [id])

  @@index([orderId])
  @@index([agentId])
  @@index([status])
}

model DeliveryFeeConfig {
  id        String   @id @default(cuid())
  fromCity  String   @db.VarChar(100)
  toWilaya  String   @db.VarChar(100)
  baseFee   Int      @default(500)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([fromCity, toWilaya])
  @@index([fromCity])
  @@index([toWilaya])
}

model SystemConfig {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt
  updatedBy String?

  @@index([key])
}

enum OrderStatus {
  PENDING
  PAYMENT_PENDING
  CONFIRMED
  AT_MERCHANT
  READY_FOR_PICKUP
  WITH_DELIVERY_AGENT
  OUT_FOR_DELIVERY
  SHIPPED
  DELIVERED
  RETURNED
  CANCELLED
}

enum DeliveryStatus {
  PENDING
  ACCEPTED
  READY_TO_SHIP
  PICKED_UP
  IN_TRANSIT
  DELIVERED
  FAILED
  RETURNED
}

enum Role {
  BUYER
  SELLER
  DELIVERY_AGENT
  ADMIN
}
